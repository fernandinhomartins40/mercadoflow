<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*"
           Name="MercadoFlow Desktop Collector"
           Language="1046"
           Version="1.0.0.0"
           Manufacturer="MercadoFlow"
           UpgradeCode="A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="MercadoFlow Desktop Collector - Sistema de coleta automática de XMLs de NFe/NFCe"
             Comments="Instalador do MercadoFlow Desktop Collector v1.0.0" />

    <MajorUpgrade DowngradeErrorMessage="Uma versão mais recente do [ProductName] já está instalada." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Ícone do instalador -->
    <Icon Id="icon.ico" SourceFile="Resources\mercadoflow.ico"/>
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />

    <!-- Interface do instalador -->
    <UI Id="WixUI_InstallDir">
      <UIRef Id="WixUI_InstallDir" />
      <UIRef Id="WixUI_ErrorProgressText" />
    </UI>

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <Feature Id="ProductFeature" Title="MercadoFlow Desktop Collector" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ProductConfigFiles" />
    </Feature>
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="MercadoFlow">
          <Directory Id="DataFolder" Name="Data" />
          <Directory Id="LogsFolder" Name="Logs" />
          <Directory Id="UploadsFolder" Name="Uploads" />
        </Directory>
      </Directory>

      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="MercadoFlow"/>
      </Directory>

      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="*">
        <File Id="MercadoFlowDesktopExe"
              Source="$(var.SourceDir)\MercadoFlow.Desktop.exe"
              KeyPath="yes"
              Checksum="yes"/>

        <!-- Atalho no Menu Iniciar -->
        <Shortcut Id="StartMenuShortcut"
                  Directory="ApplicationProgramsFolder"
                  Name="MercadoFlow Desktop"
                  Description="Coletor automático de XMLs de vendas"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="icon.ico"
                  IconIndex="0"
                  Advertise="yes"/>

        <!-- Atalho na Área de Trabalho -->
        <Shortcut Id="DesktopShortcut"
                  Directory="DesktopFolder"
                  Name="MercadoFlow Desktop"
                  Description="Coletor automático de XMLs de vendas"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="icon.ico"
                  IconIndex="0"
                  Advertise="yes"/>

        <!-- Registrar para desinstalação -->
        <RemoveFolder Id="CleanupApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RemoveFolder Id="CleanupDesktopShortcut" Directory="DesktopFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\MercadoFlow\Desktop"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="no"/>
      </Component>

      <!-- DLLs necessárias -->
      <Component Id="AppDependencies" Guid="*">
        <File Id="MercadoFlowDesktopDll" Source="$(var.SourceDir)\MercadoFlow.Desktop.dll"/>
        <File Id="MercadoFlowDesktopRuntimeConfigJson" Source="$(var.SourceDir)\MercadoFlow.Desktop.runtimeconfig.json"/>
        <File Id="MercadoFlowDesktopDepsJson" Source="$(var.SourceDir)\MercadoFlow.Desktop.deps.json"/>
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="ProductConfigFiles" Directory="INSTALLFOLDER">
      <Component Id="ConfigFiles" Guid="*">
        <File Id="AppSettingsJson" Source="$(var.SourceDir)\appsettings.json"/>
        <File Id="NLogConfig" Source="$(var.SourceDir)\NLog.config"/>
      </Component>
    </ComponentGroup>

    <!-- Criar pastas vazias -->
    <Component Id="DataFolderComponent" Directory="DataFolder" Guid="*">
      <CreateFolder>
        <Permission User="Everyone" GenericAll="yes"/>
      </CreateFolder>
      <RemoveFolder Id="RemoveDataFolder" On="uninstall"/>
      <RegistryValue Root="HKCU"
                     Key="Software\MercadoFlow\Desktop"
                     Type="string"
                     Value="[DataFolder]"
                     KeyPath="yes"/>
    </Component>

    <Component Id="LogsFolderComponent" Directory="LogsFolder" Guid="*">
      <CreateFolder>
        <Permission User="Everyone" GenericAll="yes"/>
      </CreateFolder>
      <RemoveFolder Id="RemoveLogsFolder" On="uninstall"/>
      <RegistryValue Root="HKCU"
                     Key="Software\MercadoFlow\Desktop\Logs"
                     Type="string"
                     Value="[LogsFolder]"
                     KeyPath="yes"/>
    </Component>
  </Fragment>
</Wix>
